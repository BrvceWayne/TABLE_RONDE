<div class="restaurants">

  <%# Titre %>
  <div class="restaurants__title">
    <span class="restaurants__title-icon">üéâ</span>
    <h1 class="restaurants__title-text">Nos recommandations</h1>
    <p class="restaurants__subtitle">Bas√©es sur les pr√©f√©rences de tous les participants</p>
  </div>

  <%# Carousel 3D %>
  <div class="carousel" data-controller="carousel">
    <div class="carousel__stage">

      <% @restaurants.sort_by(&:rank).each do |restaurant| %>
        <article class="carousel__card" data-carousel-target="card">
          <div class="restaurant-card <%= 'restaurant-card--featured' if restaurant.rank == 1 %>">

            <% if restaurant.rank == 1 %>
              <%# Particules d'√©toiles autour du winner %>
              <div class="restaurant-card__particles">
                <% 12.times do |i| %>
                  <span class="restaurant-card__particle restaurant-card__particle--<%= i + 1 %>"></span>
                <% end %>
              </div>
              <div class="restaurant-card__glow"></div>
            <% end %>

            <%# Photo du restaurant (si disponible) %>
            <% if restaurant.photo_url.present? %>
              <div class="restaurant-card__photo">
                <%= image_tag restaurant.photo_url, alt: restaurant.name %>
              </div>
            <% end %>

            <%# Badge %>
            <div class="restaurant-card__badge">
              <span class="restaurant-card__rank <%= restaurant.rank == 1 ? 'restaurant-card__rank--winner' : 'restaurant-card__rank--alternative' %>">
                <%= restaurant.rank == 1 ? 'üèÜ' : "##{restaurant.rank}" %>
              </span>
            </div>

            <%# Header %>
            <div class="restaurant-card__header">
              <% if restaurant.rank == 1 %>
                <span class="restaurant-card__winner-label">
                  <span>‚≠ê</span> Notre meilleur choix
                </span>
              <% end %>
              <h2 class="restaurant-card__name"><%= restaurant.name %></h2>

              <%# Infos rapides : cuisine, rating, prix %>
              <div class="restaurant-card__meta">
                <% if restaurant.cuisine_type.present? %>
                  <span class="restaurant-card__cuisine"><%= restaurant.cuisine_type %></span>
                <% end %>
                <% if restaurant.rating.present? %>
                  <span class="restaurant-card__rating">
                    <span class="restaurant-card__rating-star">‚òÖ</span>
                    <%= number_with_precision(restaurant.rating, precision: 1) %>
                  </span>
                <% end %>
                <% if restaurant.price_level.present? %>
                  <span class="restaurant-card__price">
                    <%= '‚Ç¨' * restaurant.price_level %><span class="restaurant-card__price-faded"><%= '‚Ç¨' * (4 - restaurant.price_level) %></span>
                  </span>
                <% end %>
              </div>

              <p class="restaurant-card__address">
                <span class="restaurant-card__address-icon">üìç</span>
                <span><%= restaurant.address %></span>
              </p>
            </div>

            <%# Body %>
            <div class="restaurant-card__body">
              <%# Statut ouvert/ferm√© %>
              <% if restaurant.is_open_now != nil %>
                <div class="restaurant-card__status <%= restaurant.is_open_now ? 'restaurant-card__status--open' : 'restaurant-card__status--closed' %>">
                  <span class="restaurant-card__status-dot"></span>
                  <%= restaurant.is_open_now ? 'Ouvert' : 'Ferm√©' %>
                </div>
              <% end %>

              <div class="restaurant-card__explanation">
                <%= restaurant.ai_explanation %>
              </div>

              <%# Actions %>
              <div class="restaurant-card__actions">
                <% if restaurant.phone.present? %>
                  <%= link_to "tel:#{restaurant.phone}", class: "restaurant-card__action" do %>
                    <span>üìû</span> Appeler
                  <% end %>
                <% end %>

                <% if restaurant.address.present? %>
                  <%= link_to "https://www.google.com/maps/search/?api=1&query=#{ERB::Util.url_encode(restaurant.address)}",
                      target: "_blank",
                      rel: "noopener",
                      class: "restaurant-card__action restaurant-card__action--primary" do %>
                    <span>üìç</span> Itin√©raire
                  <% end %>
                <% end %>

                <% if restaurant.website.present? %>
                  <%= link_to restaurant.website,
                      target: "_blank",
                      rel: "noopener",
                      class: "restaurant-card__action" do %>
                    <span>üåê</span> Site
                  <% end %>
                <% end %>
              </div>
            </div>

          </div>
        </article>
      <% end %>

    </div>

    <%# Navigation %>
    <button class="carousel__nav carousel__nav--prev" data-carousel-target="prev" data-action="click->carousel#prev">
      <span>‚Äπ</span>
    </button>
    <button class="carousel__nav carousel__nav--next" data-carousel-target="next" data-action="click->carousel#next">
      <span>‚Ä∫</span>
    </button>

    <%# Dots %>
    <div class="carousel__dots"></div>
  </div>

  <%# Actions %>
  <section class="restaurants__actions">
    <%= link_to dashboard_session_path(share_code: @session.share_code), class: "restaurants__btn restaurants__btn--secondary" do %>
      <span>‚Üê</span> Retour au dashboard
    <% end %>

    <%= button_to regenerate_session_restaurants_path(session_share_code: @session.share_code),
        method: :post,
        class: "restaurants__btn restaurants__btn--warning",
        data: { turbo: false } do %>
      <span>üîÑ</span> Nouvelles recommandations
    <% end %>
  </section>

</div>
