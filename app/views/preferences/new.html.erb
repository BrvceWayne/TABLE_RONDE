<%#
  PREFERENCES - Question Cards Stack
  Système de cartes empilées avec navigation question par question
  Les réponses servent d'input pour le prompt IA de recommandation
%>

<div class="question-stack"
     data-controller="question-stack"
     data-action="keydown@window->question-stack#keydown touchstart->question-stack#touchStart touchend->question-stack#touchEnd">

  <%# Header avec progression %>
  <div class="question-stack__header">
    <h1 class="question-stack__title">Vos envies</h1>
    <div class="question-stack__progress-steps" data-question-stack-target="progressSteps">
      <button type="button" class="progress-step progress-step--active" data-step="0" data-action="click->question-stack#goToStep">
        <i class="fa-solid fa-utensils"></i>
      </button>
      <button type="button" class="progress-step" data-step="1" data-action="click->question-stack#goToStep">
        <i class="fa-solid fa-leaf"></i>
      </button>
      <button type="button" class="progress-step" data-step="2" data-action="click->question-stack#goToStep">
        <i class="fa-solid fa-euro-sign"></i>
      </button>
      <button type="button" class="progress-step" data-step="3" data-action="click->question-stack#goToStep">
        <i class="fa-solid fa-location-dot"></i>
      </button>
      <button type="button" class="progress-step" data-step="4" data-action="click->question-stack#goToStep">
        <i class="fa-solid fa-champagne-glasses"></i>
      </button>
      <button type="button" class="progress-step" data-step="5" data-action="click->question-stack#goToStep">
        <i class="fa-solid fa-star"></i>
      </button>
    </div>
  </div>

  <%= form_with model: @preference, url: session_preferences_path(session_share_code: @session.share_code), method: :post, local: true, class: "question-stack__form" do |f| %>

    <%# Container des cartes empilées %>
    <div class="question-stack__cards">

      <%# Card 1 - Types de cuisine (style Forest/Lime) %>
      <div class="question-card question-card--forest question-card--active" data-question-stack-target="card">
        <div class="question-card__number">01</div>
        <div class="question-card__content">
          <h2 class="question-card__title">Quelles cuisines vous tentent ?</h2>
          <p class="question-card__hint">Plusieurs choix possibles</p>

          <div class="question-card__options question-card__options--grid">
            <% %w[Française Italienne Japonaise Chinoise Indienne Mexicaine Libanaise Thaïlandaise Américaine Coréenne Vietnamienne Grecque].each do |cuisine| %>
              <label class="question-tag question-tag--lime">
                <%= f.check_box :cuisine_types, { multiple: true, checked: @preference.cuisine_types&.include?(cuisine) }, cuisine, nil %>
                <span class="question-tag__label"><%= cuisine %></span>
              </label>
            <% end %>

            <%# Option "Autre" avec input texte %>
            <div class="question-tag-other question-tag-other--lime">
              <span class="question-tag-other__label">Autre :</span>
              <%= f.text_field :other_cuisine, value: nil, class: "question-tag-other__input", placeholder: "Péruvienne, Éthiopienne..." %>
            </div>
          </div>
        </div>
        <div class="question-card__decoration question-card__decoration--fork"></div>
        <button type="button" class="question-card__next-btn" data-action="click->question-stack#next">
          Suivant <i class="fa-solid fa-arrow-right"></i>
        </button>
      </div>

      <%# Card 2 - Régimes alimentaires (style Tangerine) %>
      <div class="question-card question-card--tangerine question-card--next" data-question-stack-target="card">
        <div class="question-card__number">02</div>
        <div class="question-card__content">
          <h2 class="question-card__title">Des restrictions alimentaires ?</h2>
          <p class="question-card__hint">Optionnel</p>

          <div class="question-card__options">
            <% %w[Végétarien Végan Sans\ gluten Halal Casher Sans\ lactose].each do |restriction| %>
              <label class="question-tag question-tag--white">
                <%= f.check_box :dietary_restrictions, { multiple: true, checked: @preference.dietary_restrictions&.include?(restriction) }, restriction, nil %>
                <span class="question-tag__label"><%= restriction %></span>
              </label>
            <% end %>
          </div>
        </div>
        <div class="question-card__decoration question-card__decoration--leaf"></div>
        <div class="question-card__nav">
          <button type="button" class="question-card__prev-btn" data-action="click->question-stack#previous">
            <i class="fa-solid fa-arrow-left"></i>
          </button>
          <button type="button" class="question-card__next-btn" data-action="click->question-stack#next">
            Suivant <i class="fa-solid fa-arrow-right"></i>
          </button>
        </div>
      </div>

      <%# Card 3 - Budget (style Sunshine) %>
      <div class="question-card question-card--sunshine question-card--next-2" data-question-stack-target="card">
        <div class="question-card__number">03</div>
        <div class="question-card__content">
          <h2 class="question-card__title">Quel budget par personne ?</h2>
          <p class="question-card__hint">Choisissez une gamme de prix</p>

          <div class="question-card__budget-levels">
            <% [
              { value: '€', label: '€', sublabel: 'Moins de 15€', min: 0, max: 15 },
              { value: '€€', label: '€€', sublabel: '15 à 30€', min: 15, max: 30 },
              { value: '€€€', label: '€€€', sublabel: '30 à 50€', min: 30, max: 50 },
              { value: '€€€€', label: '€€€€', sublabel: '50€ et plus', min: 50, max: 200 }
            ].each do |budget| %>
              <label class="budget-level">
                <%= f.radio_button :budget_level, budget[:value],
                    class: "budget-level__input",
                    data: { budget_min: budget[:min], budget_max: budget[:max] } %>
                <span class="budget-level__card">
                  <span class="budget-level__label"><%= budget[:label] %></span>
                  <span class="budget-level__sublabel"><%= budget[:sublabel] %></span>
                </span>
              </label>
            <% end %>
          </div>

          <%# Champs cachés pour stocker les valeurs min/max %>
          <%= f.hidden_field :budget_min, value: @preference.budget_min, data: { question_stack_target: "budgetMin" } %>
          <%= f.hidden_field :budget_max, value: @preference.budget_max, data: { question_stack_target: "budgetMax" } %>
        </div>
        <div class="question-card__decoration question-card__decoration--coins"></div>
        <div class="question-card__nav">
          <button type="button" class="question-card__prev-btn" data-action="click->question-stack#previous">
            <i class="fa-solid fa-arrow-left"></i>
          </button>
          <button type="button" class="question-card__next-btn" data-action="click->question-stack#next">
            Suivant <i class="fa-solid fa-arrow-right"></i>
          </button>
        </div>
      </div>

      <%# Card 4 - Localisation et Distance (style Bubblegum) %>
      <div class="question-card question-card--bubblegum question-card--hidden" data-question-stack-target="card" data-controller="geolocation">
        <div class="question-card__number">04</div>
        <div class="question-card__content">
          <h2 class="question-card__title">Où êtes-vous ?</h2>
          <p class="question-card__hint">Pour trouver un lieu accessible à tous</p>

          <%# Champs cachés pour lat/lng %>
          <%= f.hidden_field :latitude, data: { geolocation_target: "latitude" } %>
          <%= f.hidden_field :longitude, data: { geolocation_target: "longitude" } %>

          <%# Bouton de géolocalisation %>
          <div class="geolocation-container">
            <button type="button" class="geolocation-btn" data-geolocation-target="button" data-action="click->geolocation#locate">
              <i class="fa-solid fa-location-crosshairs"></i> Me localiser
            </button>
            <span class="geolocation-status" data-geolocation-target="status"></span>
          </div>

          <%# Adresse (affichée après géoloc ou saisie manuelle - avec Google Places Autocomplete) %>
          <%= f.text_field :address, class: "question-card__input", placeholder: "Ou saisissez une adresse...", autocomplete: "off", data: { geolocation_target: "address" } %>

          <div class="question-card__separator"></div>

          <h3 class="question-card__subtitle">Distance max</h3>
          <div class="question-card__distance-pills">
            <% [
              { value: 500, label: '500m' },
              { value: 1000, label: '1 km' },
              { value: 2000, label: '2 km' },
              { value: 5000, label: '5 km' },
              { value: 10000, label: '10 km' }
            ].each do |distance| %>
              <label class="distance-pill">
                <%= f.radio_button :max_distance, distance[:value],
                    class: "distance-pill__input",
                    checked: @preference.max_distance == distance[:value] || (@preference.max_distance.nil? && distance[:value] == 2000) %>
                <span class="distance-pill__label"><%= distance[:label] %></span>
              </label>
            <% end %>
          </div>
        </div>
        <div class="question-card__decoration question-card__decoration--pin"></div>
        <div class="question-card__nav">
          <button type="button" class="question-card__prev-btn" data-action="click->question-stack#previous">
            <i class="fa-solid fa-arrow-left"></i>
          </button>
          <button type="button" class="question-card__next-btn" data-action="click->question-stack#next">
            Suivant <i class="fa-solid fa-arrow-right"></i>
          </button>
        </div>
      </div>

      <%# Card 5 - Ambiance (style Electric Blue) %>
      <div class="question-card question-card--blue question-card--hidden" data-question-stack-target="card">
        <div class="question-card__number">05</div>
        <div class="question-card__content">
          <h2 class="question-card__title">Quelle ambiance ?</h2>
          <p class="question-card__hint">Plusieurs choix possibles</p>

          <div class="question-card__options">
            <% %w[Décontracté Romantique Festif Calme Branché Familial Cosy Animé Chic Intime].each do |ambiance| %>
              <label class="question-tag question-tag--blue">
                <%= f.check_box :ambiance_tags, { multiple: true, checked: @preference.ambiance&.include?(ambiance) }, ambiance, nil %>
                <span class="question-tag__label"><%= ambiance %></span>
              </label>
            <% end %>
          </div>

          <%# Champ caché pour stocker la valeur combinée %>
          <%= f.hidden_field :ambiance, value: @preference.ambiance, data: { question_stack_target: "ambianceHidden" } %>
        </div>
        <div class="question-card__decoration question-card__decoration--stars"></div>
        <div class="question-card__nav">
          <button type="button" class="question-card__prev-btn" data-action="click->question-stack#previous">
            <i class="fa-solid fa-arrow-left"></i>
          </button>
          <button type="button" class="question-card__next-btn" data-action="click->question-stack#next">
            Suivant <i class="fa-solid fa-arrow-right"></i>
          </button>
        </div>
      </div>

      <%# Card 6 - Demandes spéciales (style Cream/minimal) %>
      <div class="question-card question-card--cream question-card--hidden" data-question-stack-target="card">
        <div class="question-card__number">06</div>
        <div class="question-card__content">
          <h2 class="question-card__title">Une dernière chose ?</h2>
          <p class="question-card__hint">Terrasse, parking, accès PMR...</p>

          <%= f.text_area :special_requests, value: @preference.special_requests, placeholder: "Ex: On aimerait une terrasse si possible, et un endroit qui accepte les chiens...", class: "question-card__textarea", rows: 3 %>
        </div>
        <div class="question-card__nav question-card__nav--final">
          <button type="button" class="question-card__prev-btn" data-action="click->question-stack#previous">
            <i class="fa-solid fa-arrow-left"></i>
          </button>
          <%= f.submit "Valider mes préférences", class: "question-card__submit-btn" %>
        </div>
      </div>

    </div>

  <% end %>
</div>
