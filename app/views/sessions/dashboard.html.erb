<div class="dashboard" data-controller="session-channel" data-session-channel-share-code-value="<%= @session.share_code %>">

  <div class="dashboard__content">

    <%# Logo centrÃ© %>
    <%= link_to root_path, class: "dashboard__logo" do %>
      <span class="dashboard__logo-left">TableR</span>
      <span class="dashboard__logo-icon">
        <span class="dashboard__logo-circle"></span>
        <span class="dashboard__logo-fork"></span>
        <span class="dashboard__logo-knife"></span>
      </span>
      <span class="dashboard__logo-right">nde</span>
    <% end %>

    <%# Nom de la session %>
    <% if @session.name.present? %>
      <h1 class="dashboard__session-name"><%= @session.name %></h1>
    <% end %>

    <%# Section code de partage (leader only) %>
    <% if @is_leader %>
      <section class="dashboard__share" data-controller="share" data-share-url-value="<%= join_session_url(@session.share_code) %>" data-share-title-value="TableRonde - <%= @session.name.presence || @session.meal_type %>" data-share-text-value="Rejoins-moi pour choisir oÃ¹ manger !">
        <p class="dashboard__share-label">Partagez ce code avec vos amis</p>

        <%# QR Code %>
        <div class="dashboard__qr">
          <%= qr_code_svg(join_session_url(@session.share_code), size: 160) %>
        </div>

        <%# Code en lettres %>
        <div class="dashboard__code">
          <% @session.share_code.chars.each do |char| %>
            <span class="dashboard__code-digit"><%= char %></span>
          <% end %>
        </div>

        <%# Boutons de partage %>
        <div class="dashboard__share-buttons">
          <button class="dashboard__share-btn dashboard__share-btn--copy"
                  data-controller="clipboard"
                  data-action="click->clipboard#copy"
                  data-clipboard-text-value="<%= join_session_url(@session.share_code) %>">
            <span class="dashboard__share-btn-icon">ğŸ“‹</span>
            <span>Copier</span>
          </button>

          <button class="dashboard__share-btn dashboard__share-btn--native"
                  data-action="click->share#share"
                  data-share-target="button">
            <span class="dashboard__share-btn-icon">ğŸ“¤</span>
            <span>Partager</span>
          </button>
        </div>
      </section>
    <% end %>

    <%# Info repas %>
    <div class="dashboard__meal-badge">
      <% meal_icons = { 'Petit-dÃ©jeuner' => 'ğŸ¥', 'Brunch' => 'â˜€ï¸', 'DÃ©jeuner' => 'ğŸ½ï¸', 'DÃ®ner' => 'ğŸŒ™' } %>
      <span class="dashboard__meal-icon"><%= meal_icons[@session.meal_type] || 'ğŸ´' %></span>
      <span class="dashboard__meal-type"><%= @session.meal_type %></span>
    </div>

    <%# Section participants %>
    <section class="dashboard__participants">
      <h2 class="dashboard__section-title">
        Participants
        <span class="dashboard__count"><%= @participants_status.size %></span>
      </h2>

      <div class="dashboard__participants-grid">
        <% @participants_status.each do |p| %>
          <div class="dashboard__participant-card <%= 'dashboard__participant-card--completed' if p[:preferences_completed] %>">
            <div class="dashboard__participant-avatar">
              <% if p[:user].guest? %>
                <%= p[:guest_name].present? ? p[:guest_name][0].upcase : 'ğŸ‘¤' %>
              <% else %>
                <%= p[:user].email[0].upcase %>
              <% end %>
            </div>
            <div class="dashboard__participant-info">
              <span class="dashboard__participant-name">
                <% if p[:user].guest? %>
                  <%= p[:guest_name].presence || "InvitÃ©" %>
                <% else %>
                  <%= p[:user].email.split('@').first %>
                <% end %>
              </span>
              <% if p[:leader] %>
                <span class="dashboard__participant-role">Leader</span>
              <% end %>
            </div>
            <div class="dashboard__participant-status">
              <% if p[:preferences_completed] %>
                <span class="dashboard__status-badge dashboard__status-badge--success">âœ“</span>
              <% else %>
                <span class="dashboard__status-badge dashboard__status-badge--pending">
                  <span class="dashboard__hourglass">â³</span>
                </span>
              <% end %>
            </div>
          </div>
        <% end %>
      </div>
    </section>

    <%# Actions %>
    <section class="dashboard__actions">
      <% if @is_participant %>
        <%= link_to new_session_preference_path(session_share_code: @session.share_code), class: "dashboard__btn dashboard__btn--secondary" do %>
          <span>ğŸ“</span> Mes prÃ©fÃ©rences
        <% end %>
      <% else %>
        <%= link_to join_session_path(@session.share_code), class: "dashboard__btn dashboard__btn--secondary" do %>
          <span>â•</span> Rejoindre
        <% end %>
      <% end %>

      <% if @session.restaurants.any? %>
        <%= link_to session_restaurants_path(session_share_code: @session.share_code), class: "dashboard__btn dashboard__btn--primary" do %>
          <span>ğŸ´</span> Voir les restos
        <% end %>
      <% elsif @is_leader %>
        <div data-controller="generate-overlay" data-generate-overlay-url-value="<%= generate_recommendations_session_path(share_code: @session.share_code) %>">
          <button type="button" class="dashboard__btn dashboard__btn--primary" data-action="click->generate-overlay#start">
            <span>âœ¨</span> GÃ©nÃ©rer les restos
          </button>
        </div>
      <% else %>
        <div class="dashboard__waiting">
          <span class="dashboard__waiting-icon">â³</span>
          <span>En attente du leader...</span>
        </div>
      <% end %>
    </section>

  </div>
</div>
